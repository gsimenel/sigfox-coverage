angular.module("ngMaps",[]),angular.module("ngMaps").factory("GeoJSONService",function(){function toLatLng(c){return new google.maps.LatLng(c[1],c[0])}function setEvents(events,feature,map){for(var eventType in events)google.maps.event.addListener(feature,eventType,function(e){events[eventType](e,feature,map)});return feature}function Point(geometry,properties,options,events,map){function setOptions(options){_options=options(_coords,properties,map,0),_options.properties=properties,_feature.setOptions(_options)}function setPosition(coords){_coords=coords,_feature.setPosition(toLatLng(coords))}function setProperties(properties){_properties=properties,setOptions(options)}function setVisible(visible){_feature.setVisible(visible)}function getMapFeature(){return _feature}var _coords=geometry.coordinates,_properties=properties,_options=options(_coords,properties,map,0);_options.position=toLatLng(_coords),_options.map=map;var _feature=new google.maps.Marker(_options);return _feature=setEvents(events,_feature,map),{setOptions:setOptions,setEvents:setEvents,setPosition:setPosition,setProperties:setProperties,setVisible:setVisible,getMapFeature:getMapFeature}}function LineString(geometry,properties,options,events,map){function setOptions(options){_options=options(_coords,properties,map,0),_feature.setOptions(_options)}function setProperties(properties){_properties=properties,setOptions(options)}function setPath(coords){_coords=coords,_feature.setPath(coords.map(toLatLng))}function setVisible(visible){_feature.setVisible(visible)}function setOpacity(opacity){opacity>1&&(opacity/=100),_opacity=opacity,_options.strokeOpacity=_opacity,_feature.setOptions(_options)}function getMapFeature(){return _feature}var _coords=geometry.coordinates,_properties=properties,_options=options(_coords,properties,map,0);_options.path=_coords.map(toLatLng),_options.map=map;var _opacity,_feature=new google.maps.Polyline(_options);return _feature=setEvents(events,_feature,map),{setOptions:setOptions,setEvents:setEvents,setProperties:setProperties,setPath:setPath,setVisible:setVisible,setOpacity:setOpacity,getMapFeature:getMapFeature}}function Polygon(geometry,properties,options,events,map){function setOptions(options){_options=options(_coords,properties,map,0),_feature.setOptions(_options)}function setVisible(visible){_feature.setVisible(visible)}function setProperties(properties){_properties=properties,setOptions(options)}function setPath(coords){_coords=coords,_feature.setPaths(coords.map(function(c){return c.map(toLatLng)}))}function setOpacity(opacity){opacity>1&&(opacity/=100),_opacity=opacity,_options.strokeOpacity=_opacity,_options.fillOpacity=_opacity,_feature.setOptions(_options)}function getMapFeature(){return _feature}var _coords=geometry.coordinates,_properties=properties,_options=options(_coords,properties,map,0);_options.paths=_coords.map(function(c){return c.map(toLatLng)}),_options.map=map;var _opacity,_feature=new google.maps.Polygon(_options);return _feature=setEvents(events,_feature,map),{setOptions:setOptions,setEvents:setEvents,setVisible:setVisible,setPath:setPath,setProperties:setProperties,setOpacity:setOpacity,getMapFeature:getMapFeature}}return{Point:Point,LineString:LineString,Polygon:Polygon}}),angular.module("ngMaps").factory("MultiPolygonService",function(){return function(p,i,map,options,opacity){this.type=p.geometry.type,this.properties=p.properties,this.setOptions=function(o){angular.forEach(polygons,function(p){p.setOptions(o)})},this.setVisible=function(o){angular.forEach(polygons,function(p){p.setVisible(o)})},this.getMap=function(o){angular.forEach(polygons,function(p){p.getMap(o)})};var polygons=[],opts=options?options(p.geometry,p.properties,i,map):{};if(opts.fillOpacity=opacity?opacity/100:1,"MultiPolygon"===this.type)angular.forEach(p.geometry.coordinates,function(c){angular.forEach(c,function(c2){var coords=[];angular.forEach(c2,function(c3){coords.push(new google.maps.LatLng(c3[1],c3[0]))});var polygon=new google.maps.Polygon({paths:coords});polygon.setOptions(opts),polygon.setMap(map),polygons.push(polygon)})});else{var coords=[];angular.forEach(p.geometry.coordinates,function(c){angular.forEach(c,function(c2){coords.push(new google.maps.LatLng(c2[1],c2[0]))})});var polygon=new google.maps.Polygon({paths:coords});polygon.setOptions(opts),polygon.setMap(map),polygons.push(polygon)}this.polygons=polygons}}),angular.module("ngMaps").directive("circles",[function(){return{restrict:"E",scope:{geometries:"=",events:"=",visible:"=",options:"=",opacity:"=",properties:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){function newData(){angular.forEach(circles,function(c){c.setMap(null)}),circles=[],angular.forEach($scope.geometries,function(c,i){var opts=$scope.options?$scope.options(c,properties,map,i):{};opts.center=new google.maps.LatLng(c.center[0],c.center[1]),opts.radius=c.radius,opts.map=map;var circle=new google.maps.Circle(opts);circles.push(circle),angular.forEach($scope.events,function(val,key){google.maps.event.addListener(circle,key,function(e){val(e,this,circles,i)})})})}var map=parent.getMap(),circles=[],properties=$scope.properties?$scope.properties:[];$scope.$watch("visible",function(){angular.forEach(circles,function(c){c.setVisible($scope.visible)})}),$scope.$watch("options",function(){angular.forEach(circles,function(c,i){c.setOptions($scope.options(c,properties,map,i))})}),$scope.$watch("geometries",function(){newData()}),$scope.$watch("opacity",function(){$scope.opacity&&angular.forEach(circles,function(c){c.setOptions({fillOpacity:$scope.opacity/100})})})})}}}]),angular.module("ngMaps").directive("control",["$compile",function($compile){return{restrict:"E",scope:{position:"@",visible:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){var map=parent.getMap(),position=$scope.position.split(/(?=[A-Z])/).join("_").toUpperCase();$scope.$watch(function(){return $element[0].style.display="none",$element[0].innerHTML},function(){var content=$element.html(),compiled=$compile($element.html())($scope.$parent.$parent),controlDiv=document.createElement("div"),controlList=map.controls[google.maps.ControlPosition[position]];controlList.length>0&&map.controls[google.maps.ControlPosition[position]].pop(),$scope.visible!==!1&&(controlDiv.innerHTML=content),map.controls[google.maps.ControlPosition[position]].push(compiled[0])})})}}}]),angular.module("ngMaps").directive("featureCollection",["$http","GeoJSONService",function($http,GeoJSON){return{restrict:"E",scope:{events:"=?",geojson:"=?",onInit:"=?",opacity:"=?",options:"=?",url:"=?",visible:"=?"},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){function optionsOfType(type,options){var isFunction="function"==typeof options[type];return isFunction?options[type]:function(){return{}}}function eventsOfType(type,events){var isObject="object"==typeof events[type];return isObject?events[type]:{}}function newData(data){function newFeature(f){var type=f.geometry.type,options=optionsOfType(type,$scope.options),events=eventsOfType(type,$scope.events),feature=GeoJSON[type](f.geometry,f.properties,options,events,map);features.push(feature.getMapFeature()),$scope.$watch("options",function(newOptions){newOptions&&feature.setOptions(optionsOfType(type,newOptions))}),$scope.$watch("opacity",function(opacity){opacity&&feature.setOpacity&&feature.setOpacity(opacity)}),$scope.$watch("visible",function(visible){"boolean"==typeof visible&&feature.setVisible(visible)})}for(var features=[],i=0;i<data.features.length;i++)newFeature(data.features[i]);$scope.onInit&&$scope.onInit(features,data)}var map=parent.getMap();$scope.options||($scope.options={}),$scope.events||($scope.events={}),$scope.geojson?newData($scope.geojson):$scope.url&&$http.get(url).then(function(success){newData(success.data)})})}}}]),angular.module("ngMaps").directive("geopoints",["$http",function($http){return{restrict:"E",scope:{url:"=",events:"=",visible:"=",options:"=",onInit:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){function newData(url){$http.get(url).success(function(data){angular.forEach(markers,function(m){m.setMap(null)}),markers=[],angular.forEach(data.features,function(m,i){var opts=$scope.options?$scope.options(m.geometry,m.properties,map,i):{};opts.position=new google.maps.LatLng(m.geometry.coordinates[1],m.geometry.coordinates[0]),opts.visible=$scope.visible,opts.map=map;var marker=new google.maps.Marker(opts);marker.properties=m.properties,marker.geometry=m.geometry,marker.getProperty=function(p){return this.properties[p]},markers.push(marker),angular.forEach($scope.events,function(val,key){google.maps.event.addListener(marker,key,function(e){val(e,marker,map,markers)})})}),$scope.onInit&&$scope.onInit(markers)})}var map=parent.getMap(),markers=[];$scope.$watch(function(){return $scope.options},function(){angular.forEach(markers,function(m,i){marker.setOptions($scope.options(m.geometry,m.properties,map,i))})}),$scope.$watch(function(){return $scope.visible},function(){angular.forEach(markers,function(marker){marker.setVisible($scope.visible)})}),$scope.$watch(function(){return $scope.url},function(){newData($scope.url)})})}}}]),angular.module("ngMaps").directive("geopolygons",["$http",function($http){return{restrict:"E",scope:{url:"=",events:"=",options:"=",visible:"=",opacity:"=",onInit:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){function PolygonCollection(p,i){this.type=p.geometry.type,this.properties=p.properties,this.setOptions=function(o){angular.forEach(polygons,function(p){p.setOptions(o)})},this.setVisible=function(o){angular.forEach(polygons,function(p){p.setVisible(o)})},this.getMap=function(o){angular.forEach(polygons,function(p){p.getMap(o)})};var polygons=[],opts=$scope.options?$scope.options(p.geometry,p.properties,i,map):{};if(opts.fillOpacity=$scope.opacity?$scope.opacity/100:1,"MultiPolygon"===this.type)angular.forEach(p.geometry.coordinates,function(c){angular.forEach(c,function(c2){var coords=[];angular.forEach(c2,function(c3){coords.push(new google.maps.LatLng(c3[1],c3[0]))});var polygon=new google.maps.Polygon({paths:coords});polygon.setOptions(opts),polygon.setMap(map),polygons.push(polygon)})});else{var coords=[];angular.forEach(p.geometry.coordinates,function(c){angular.forEach(c,function(c2){coords.push(new google.maps.LatLng(c2[1],c2[0]))})});var polygon=new google.maps.Polygon({paths:coords});polygon.setOptions(opts),polygon.setMap(map),polygons.push(polygon)}this.polygons=polygons}function newData(url){$http.get(url).success(function(data){angular.forEach(polygons,function(p){p.setMap(null)}),polygons=[],angular.forEach(data.features,function(p,i){var PC=new PolygonCollection(p,i);polygons.push(PC),angular.forEach(PC.polygons,function(polygon){angular.forEach($scope.events,function(val,key){google.maps.event.addListener(polygon,key,function(e){val(e,PC,map,polygons)})})})}),$scope.onInit&&$scope.onInit(polygons)})}var map=parent.getMap(),polygons=[];$scope.$watch("options",function(){angular.forEach(polygons,function(p,i){var opts=$scope.options?$scope.options(p.geometry,p.properties,map,i):{};opts.fillOpacity=$scope.opacity?$scope.opacity/100:1,p.setOptions(opts)})}),$scope.$watch("opacity",function(){$scope.opacity&&angular.forEach(polygons,function(p){p.setOptions({fillOpacity:$scope.opacity/100})})}),$scope.$watch("visible",function(){angular.forEach(polygons,function(p){p.setVisible($scope.visible)})}),$scope.$watch("url",function(){newData($scope.url)})})}}}]),angular.module("ngMaps").directive("infowindow",["$compile",function($compile){return{restrict:"E",scope:{options:"=",position:"=",visible:"=",events:"="},require:"^map",compile:function(){return function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){var map=parent.getMap(),opts=$scope.options?$scope.options():{},infowindow=new google.maps.InfoWindow(opts);$scope.$watch(function(){return $element[0].style.display="none",$element[0].innerHTML+$scope.position},function(){var pos;pos=$scope.position.constructor===Array?new google.maps.LatLng($scope.position[0],$scope.position[1]):$scope.position;var compiled=($element.html(),$compile($element.html())($scope.$parent.$parent));infowindow.setContent(compiled[0]),infowindow.setPosition(pos),infowindow.open(map)})})}}}}]),angular.module("ngMaps").directive("kml",[function(){return{restrict:"E",scope:{url:"=",events:"=",visible:"=",options:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){function delete_kml(){kml&&(kml.setMap(null),kml=null)}function new_kml(){delete_kml();var options=$scope.options?$scope.options():{};options.url=$scope.url,options.map=map;var kml=new google.maps.KmlLayer(options);return angular.forEach($scope.events,function(val,key){google.maps.event.addListener(kml,key,function(e){val(e,kml,map)})}),kml.setMap($scope.visible!==!1?map:null),kml}var map=parent.getMap(),kml=new_kml();$scope.$watch("url",function(){kml=new_kml()}),$scope.$watch("visible",function(){kml.setMap($scope.visible!==!1?map:null)})})}}}]),angular.module("ngMaps").directive("linestring",["$http","GeoJSONService",function($http,GeoJSON){return{restrict:"E",scope:{coordinates:"=?",events:"=?",geojson:"=?",onInit:"=?",opacity:"=?",options:"=?",properties:"=?",url:"=?",visible:"=?"},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){function newData(data){var feature=GeoJSON.LineString(data.geometry,data.properties,$scope.options,$scope.events,map);$scope.$watch("coordinates",function(coords){coords&&feature.setPath(coords)},!0),$scope.$watch("geojson.geometry.coordinates",function(coords){coords&&feature.setPath(coords)},!0),$scope.$watch("options",function(newOptions){newOptions&&feature.setOptions(newOptions)}),$scope.$watch("properties",function(properties){properties&&feature.setProperties(properties)}),$scope.$watch("geojson.properties",function(properties){properties&&feature.setProperties(properties)}),$scope.$watch(function(){return $scope.opacity},function(opacity){opacity&&feature.setOpacity&&feature.setOpacity(opacity)}),$scope.$watch(function(){return $scope.visible},function(visible){"boolean"==typeof visible&&feature.setVisible(visible)}),$scope.onInit&&$scope.onInit(feature,data)}var map=parent.getMap();$scope.options||($scope.options=function(){return{}}),$scope.events||($scope.events={}),$scope.geojson?newData($scope.geojson):$scope.coordinates?newData({type:"Feature",geometry:{type:"LineString",coordinates:$scope.coordinates},properties:$scope.properties||null}):$scope.url&&$http.get(url).then(function(success){newData(success.data)})})}}}]),angular.module("ngMaps").directive("map",[function(){return{restrict:"AE",scope:{center:"=",zoom:"=",events:"=",options:"="},controller:function($scope){this.getMap=function(){return $scope.map}},transclude:!0,link:function($scope,elem,attrs){var center=$scope.center,options=$scope.options?$scope.options():{},latitude=center?center[0]:47.6,longitude=center?center[1]:-122.3;options.center=new google.maps.LatLng(latitude,longitude),$scope.zoom?options.zoom=$scope.zoom:options.zoom||(options.zoom=6),$scope.$watch("center",function(center){center&&map.panTo(new google.maps.LatLng(center[0],center[1]))});var t1=document.createElement("div");t1.className=attrs.class,elem.append(t1);var map=new google.maps.Map(t1,options);angular.forEach($scope.events,function(val,key){google.maps.event.addListener(map,key,function(e){val(e,map)})}),$scope.map=map}}}]),angular.module("ngMaps").directive("marker",[function(){return{restrict:"E",scope:{position:"=",options:"=",events:"=",lat:"=",lng:"=",decimals:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){function round(val){return decimals||0===decimals?Math.round(Math.pow(10,decimals)*val)/Math.pow(10,decimals):val}function currentPosition(){return $scope.position?new google.maps.LatLng($scope.position[0],$scope.position[1]):$scope.lat&&$scope.lng?new google.maps.LatLng($scope.lat,$scope.lng):void 0}var map=parent.getMap(),decimals=$scope.decimals,opts=$scope.options?$scope.options():{};opts.position=currentPosition(),opts.map=map;var marker=new google.maps.Marker(opts);angular.forEach($scope.events,function(val,key){google.maps.event.addListener(marker,key,function(e){val(e,marker,map)})}),$scope.$watch("[position, lat, lng]",function(){marker.setPosition(currentPosition())},!0),google.maps.event.addListener(marker,"drag",function(){$scope.$apply(function(){var lat=round(marker.getPosition().lat()),lng=round(marker.getPosition().lng());$scope.position?$scope.position=[lat,lng]:$scope.lat&&$scope.lng&&($scope.lat=lat,$scope.lng=lng)})})})}}}]),angular.module("ngMaps").directive("overlay",[function(){return{restrict:"E",scope:{url:"=",events:"=",opacity:"=",options:"=",bounds:"=",visible:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){function isFloat(n){return n===+n&&n!==(n||0)}function parseOpacity(){return isFloat($scope.opacity)?$scope.opacity:parseFloat($scope.opacity)}function deleteOverlay(){overlay&&(overlay.setMap(null),overlay=null)}function newOverlay(){deleteOverlay();var bounds;if($scope.bounds.constructor===Object){var SW=new google.maps.LatLng($scope.bounds.SW[0],$scope.bounds.SW[1]),NE=new google.maps.LatLng($scope.bounds.NE[0],$scope.bounds.NE[1]);bounds=new google.maps.LatLngBounds(SW,NE)}else bounds=$scope.bounds;var opts=$scope.options?$scope.options():{},overlay=new google.maps.GroundOverlay($scope.url,bounds,opts);return overlay.setOpacity(parseOpacity()/100),overlay.setMap($scope.visible!==!1?map:null),overlay}var map=parent.getMap(),overlay=newOverlay();$scope.$watch("url + bounds",function(){overlay=newOverlay()}),$scope.$watch("opacity",function(){overlay.setOpacity(parseOpacity()/100)}),$scope.$watch("visible",function(){overlay.setMap($scope.visible!==!1?map:null)})})}}}]),angular.module("ngMaps").directive("point",["$http","GeoJSONService",function($http,GeoJSON){return{restrict:"E",scope:{decimals:"=?",events:"=?",geojson:"=?",latitude:"=?",longitude:"=?",onInit:"=?",onMove:"=?",options:"=?",properties:"=?",url:"=?",visible:"=?"},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){function round(n){return isNaN($scope.decimals)?n:Math.round(Math.pow(10,$scope.decimals)*n)/Math.pow(10,$scope.decimals)}function newData(data){var feature=GeoJSON.Point(data.geometry,data.properties,$scope.options,$scope.events,map);$scope.$watch("[longitude, latitude]",function(coords){coords&&feature.setPosition(coords)},!0),$scope.$watch("geojson.geometry.coordinates",function(coords){coords&&feature.setPosition(coords)},!0),$scope.$watch("properties",function(properties){properties&&feature.setProperties(properties)}),$scope.$watch("geojson.properties",function(properties){properties&&feature.setProperties(properties)}),$scope.$watch("options",function(newOptions){newOptions&&feature.setOptions(newOptions)}),$scope.$watch("visible",function(visible){"boolean"==typeof visible&&feature.setVisible(visible)}),$scope.onInit&&$scope.onInit(feature,data),google.maps.event.addListener(feature.getMapFeature(),"drag",function(){$scope.$apply(function(){var lat=round(feature.getMapFeature().getPosition().lat()),lng=round(feature.getMapFeature().getPosition().lng());$scope.geojson?$scope.geojson.geometry.coordinates=[lng,lat]:isNaN($scope.latitude)||isNaN($scope.longitude)||($scope.latitude=lat,$scope.longitude=lng)})})}var map=parent.getMap();$scope.options||($scope.options=function(){return{}}),$scope.events||($scope.events={}),$scope.geojson?newData($scope.geojson):isNaN($scope.latitude)||isNaN($scope.longitude)?$scope.url&&$http.get(url).then(function(success){newData(success.data)}):newData({type:"Feature",geometry:{type:"Point",coordinates:[$scope.longitude,$scope.latitude]},properties:$scope.properties||null})})}}}]),angular.module("ngMaps").directive("points",[function(){return{restrict:"E",scope:{coords:"=",options:"=",properties:"=",events:"=",visible:"=",decimals:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){function round(val){return $scope.decimals||0===$scope.decimals?Math.round(Math.pow(10,$scope.decimals)*val)/Math.pow(10,$scope.decimals):val}function newCoords(coords){angular.forEach(points,function(p){p.setMap(null)}),points=[],angular.forEach(coords,function(c,i){var opts=$scope.options?$scope.options(c,properties,i,map):{};opts.position=new google.maps.LatLng(c[0],c[1]),opts.map=map;var point=new google.maps.Marker(opts);angular.forEach($scope.events,function(val,key){google.maps.event.addListener(point,key,function(e){val(e,this,map,points)})}),google.maps.event.addListener(point,"drag",function(){$scope.$apply(function(){var lat=round(point.getPosition().lat()),lng=round(point.getPosition().lng());$scope.coords[i]=[lat,lng]})}),points.push(point)})}var map=parent.getMap(),points=[],properties=$scope.properties?$scope.properties:[];$scope.$watch("coords",function(){newCoords($scope.coords)}),$scope.$watch("visible",function(){angular.forEach(points,function(c){c.setVisible($scope.visible)})}),$scope.$watch("options",function(){angular.forEach(points,function(c,i){c.setOptions($scope.options(c,properties,map,i))})})})}}}]),angular.module("ngMaps").directive("polygon",["$http","GeoJSONService",function($http,GeoJSON){return{restrict:"E",scope:{coordinates:"=?",events:"=?",geojson:"=?",onInit:"=?",opacity:"=?",options:"=?",properties:"=?",url:"=?",visible:"=?"},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){function newData(data){var feature=GeoJSON.Polygon(data.geometry,data.properties,$scope.options,$scope.events,map);$scope.$watch("coordinates",function(coords){coords&&feature.setPath(coords)},!0),$scope.$watch("geojson.geometry.coordinates",function(coords){coords&&feature.setPath(coords)},!0),$scope.$watch("options",function(newOptions){newOptions&&feature.setOptions(newOptions)}),$scope.$watch("properties",function(properties){properties&&feature.setProperties(properties)}),$scope.$watch("geojson.properties",function(properties){properties&&feature.setProperties(properties)}),$scope.$watch(function(){return $scope.opacity},function(opacity){opacity&&feature.setOpacity&&feature.setOpacity(opacity)}),$scope.$watch(function(){return $scope.visible},function(visible){"boolean"==typeof visible&&feature.setVisible(visible)}),$scope.onInit&&$scope.onInit(feature,data)}var map=parent.getMap();$scope.options||($scope.options=function(){return{}}),$scope.events||($scope.events={}),$scope.geojson?newData($scope.geojson):$scope.coordinates?newData({type:"Feature",geometry:{type:"Polygon",coordinates:$scope.coordinates},properties:$scope.properties||null}):$scope.url&&$http.get(url).then(function(success){newData(success.data)})})}}}]),angular.module("ngMaps").directive("polygons",[function(){return{restrict:"E",scope:{coords:"=",options:"=",properties:"=",opacity:"=",events:"=",visible:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){function newData(coords){angular.forEach(polygons,function(p){p.setMap(null)}),polygons=[],angular.forEach(coords,function(c,i){var opts=$scope.options?$scope.options(c,properties,map,i):{};opts.fillOpacity=$scope.opacity?$scope.opacity/100:1,opts.path=[],opts.map=map;for(var j=0;j<c.length;j++)for(var k=0;k<c[j].length;k++)opts.path.push(new google.maps.LatLng(c[j][k][0],c[j][k][1]));var polygon=new google.maps.Polygon(opts);$scope.properties&&(polygon.properties=$scope.properties[i]),polygon.getProperty=function(p){return this.properties[p]},polygons.push(polygon),angular.forEach($scope.events,function(val,key){google.maps.event.addListener(polygon,key,function(e){val(e,this,map,polygons)})})})}var map=parent.getMap(),polygons=[],properties=$scope.properties?$scope.properties:[];$scope.$watch("options",function(){angular.forEach(polygons,function(p){var opts=$scope.options?$scope.options(p,properties,i,map):{};opts.fillOpacity=$scope.opacity?$scope.opacity/100:1,p.setOptions(opts)})}),$scope.$watch("opacity",function(){angular.forEach(polygons,function(p){p.setOptions({fillOpacity:$scope.opacity/100})})}),$scope.$watch("visible",function(){angular.forEach(polygons,function(p){p.setVisible($scope.visible)})}),$scope.$watch("coords",function(){newData($scope.coords)})})}}}]),angular.module("ngMaps").directive("polylines",[function(){return{restrict:"E",scope:{coords:"=",options:"=",visible:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){function newData(coords){angular.forEach(lines,function(l){l.setMap(null)}),lines=[],angular.forEach(coords,function(l,i){var opts=$scope.options?$scope.options(l,properties,map,i):{};opts.path=[],angular.forEach(l,function(c){opts.path.push(new google.maps.LatLng(c[0],c[1]))}),opts.map=map;var polyline=new google.maps.Polyline(opts);lines.push(polyline),angular.forEach($scope.events,function(val,key){google.maps.event.addListener(polyline,key,function(e){val(e,this,map,lines)})})})}var map=parent.getMap(),properties=$scope.properties?$scope.properties:[],lines=[];$scope.$watch("coords",function(){newData($scope.coords)}),$scope.$watch("visible",function(){angular.forEach(lines,function(l){l.setVisible($scope.visible)})}),$scope.$watch("options",function(){angular.forEach(lines,function(l,i){l.setOptions($scope.options(l,properties,map,i))})})})}}}]),angular.module("ngMaps").directive("rectangles",["$rootScope",function($rootScope){return{restrict:"E",scope:{bounds:"=",events:"=",visible:"=",options:"=",opacity:"=",decimals:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){function round(val){return decimals||0===decimals?Math.round(Math.pow(10,decimals)*val)/Math.pow(10,decimals):val}var map=parent.getMap(),properties=$scope.properties?$scope.properties:[],rectangles=[],decimals=$scope.decimals;$scope.$watch("visible",function(){angular.forEach(rectangles,function(r){r.setVisible($scope.visible)})}),$scope.$watch("options",function(){angular.forEach(rectangles,function(r,i){r.setOptions($scope.options(r,properties,map,i))})}),$scope.$watch("bounds",function(){newData()}),$scope.$watch("opacity",function(){$scope.opacity&&angular.forEach(rectangles,function(r){r.setOptions({fillOpacity:$scope.opacity/100})})});var newData=function(){angular.forEach(rectangles,function(r){r.setMap(null)}),rectangles=[],angular.forEach($scope.bounds,function(r,i){console.log(r);var opts=$scope.options?$scope.options(r,properties,map,i):{};if(r.constructor===Object){var SW=new google.maps.LatLng(r.SW[0],r.SW[1]),NE=new google.maps.LatLng(r.NE[0],r.NE[1]);opts.bounds=new google.maps.LatLngBounds(SW,NE)}else opts.bounds=r;opts.map=map;var rect=new google.maps.Rectangle(opts);rectangles.push(rect),angular.forEach($scope.events,function(val,key){google.maps.event.addListener(rect,key,function(e){val(e,this,i,rectangles)})}),google.maps.event.addListener(rect,"bounds_changed",function(){var b=rect.getBounds(),SW=b.getSouthWest(),NE=b.getNorthEast();$scope.bounds[i]={SW:[round(SW.k),round(SW.B)],NE:[round(NE.k),round(NE.B)]},$rootScope.$apply()})})}})}}}]),angular.module("ngMaps").directive("textLabels",[function(){return{restrict:"E",scope:{features:"=",events:"=",visible:"="},require:"^map",link:function($scope,$element,$attrs,parent){$scope.$watch(function(){parent.getMap()},function(){var map=parent.getMap(),textLabels=($scope.options?$scope.options():{},[]);$scope.$watch("visible",function(visible){textLabels.forEach(visible!==!1?function(f){f.setMap(map)}:function(f){f.setMap(null)})}),angular.forEach($scope.features,function(feature){textLabel=angular.extend(new google.maps.OverlayView,{onAdd:function(){div=document.createElement("div"),div.style.borderStyle="none",div.style.borderWidth="0px",div.style.position="absolute",console.log($attrs.class),div.className=$attrs.class,div.innerHTML=feature.text;var panes=this.getPanes();panes.overlayMouseTarget.appendChild(div),angular.forEach($scope.events,function(val,key){div.addEventListener(key,function(e){val(e,feature,map,textLabels)})}),this.div_=div},draw:function(){var coords=feature.coords,overlayProjection=this.getProjection(),pos=overlayProjection.fromLatLngToDivPixel(new google.maps.LatLng(coords[0],coords[1])),div=this.div_,boundingRect=div.getBoundingClientRect();div.style.left=pos.x-boundingRect.width/2+"px",div.style.top=pos.y-boundingRect.height/2+"px"},onRemove:function(){this.div_.parentNode.removeChild(this.div_),this.div_=null}}),textLabel.setMap(map),textLabels.push(textLabel)})})}}}]);